<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>מערכת קולית להתקשרות</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 100px;
      direction: rtl;
    }
    #status {
      font-size: 1.5em;
      margin: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
    }
  </style>
</head>
<body>

<div id="status">מאזין למילת ההפעלה...</div>
<audio id="success-sound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="fail-sound" src="https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg"></audio>

<script>
  const triggerWord = "טלפון";
  const contacts = ["יוסי כהן", "דני לוי", "מירי ברק", "רון אוחנה"];
  const statusEl = document.getElementById('status');
  const successSound = document.getElementById('success-sound');
  const failSound = document.getElementById('fail-sound');

  let recognition;
  let listeningForName = false;

  function initRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'he-IL';
    recognition.interimResults = true;
    recognition.continuous = false;
  }

  function listenForTrigger() {
    initRecognition();
    statusEl.textContent = "מאזין למילת ההפעלה...";
    recognition.start();

    recognition.onresult = (event) => {
      let transcript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      if (transcript.includes(triggerWord)) {
        recognition.stop();
        statusEl.textContent = "אמור את שם איש הקשר...";
        listenForContact();
      }
    };

    recognition.onerror = () => {
      statusEl.textContent = "שגיאה. מנסה שוב...";
      setTimeout(() => listenForTrigger(), 1000);
    };
  }

  function listenForContact() {
    initRecognition();
    let detected = false;
    let contactText = "";

    recognition.start();
    const timeout = setTimeout(() => {
      recognition.stop();
    }, 8000); // 8 שניות

    recognition.onresult = (event) => {
      let fullTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        fullTranscript += event.results[i][0].transcript + ' ';
      }
      contactText = fullTranscript.trim();
      statusEl.textContent = `הוזן: ${contactText}`;
    };

    recognition.onend = () => {
      clearTimeout(timeout);
      const match = contacts.find(name => contactText.includes(name));
      if (match) {
        successSound.play();
        statusEl.textContent = `מתקשר אל ${match}...`;
        setTimeout(() => {
          window.location.href = `tel:${match.replace(/\s/g, '')}`;
        }, 1000);
      } else {
        failSound.play();
        statusEl.innerHTML = `לא זוהה, נסה שוב<br><br><button onclick="location.reload()">לחץ כדי לרענן</button>`;
      }
    };

    recognition.onerror = () => {
      failSound.play();
      statusEl.innerHTML = `שגיאה בזיהוי<br><br><button onclick="location.reload()">לחץ כדי לרענן</button>`;
    };
  }

  // Start listening as soon as page loads
  window.onload = () => {
    listenForTrigger();
  };
</script>

</body>
</html>
