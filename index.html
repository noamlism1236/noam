<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>זיהוי דיבור בלייב</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        #transcript {
            font-size: 24px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>זיהוי דיבור בלייב</h1>
    <div id="transcript">הטקסט עד כה:</div>

    <script>
        const transcriptDiv = document.getElementById('transcript');
        const contacts = ['נעם שינובר'];
        let recognition;
        let listeningForContact = false;
        let lastTranscript = '';

        function playBeep(success = true) {
            const ctx = new AudioContext();
            const oscillator = ctx.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(success ? 800 : 300, ctx.currentTime);
            oscillator.connect(ctx.destination);
            oscillator.start();
            oscillator.stop(ctx.currentTime + 0.3);
        }

        function similarity(s1, s2) {
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            const longerLength = longer.length;
            if (longerLength === 0) return 1.0;
            return (longerLength - levenshteinDistance(longer, shorter)) / parseFloat(longerLength);
        }

        function levenshteinDistance(a, b) {
            const matrix = Array.from({ length: b.length + 1 }, () => []);
            for (let i = 0; i <= b.length; i++) matrix[i][0] = i;
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    matrix[i][j] = b.charAt(i - 1) === a.charAt(j - 1)
                        ? matrix[i - 1][j - 1]
                        : Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                }
            }
            return matrix[b.length][a.length];
        }

        function startSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("הדפדפן שלך לא תומך בזיהוי דיבור");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'he-IL';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = function(event) {
                let fullTranscript = lastTranscript;
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const resultText = event.results[i][0].transcript.trim();
                    fullTranscript += ' ' + resultText;

                    if (!listeningForContact && fullTranscript.includes('טלפון')) {
                        playBeep();
                        listeningForContact = true;
                        transcriptDiv.textContent = 'הטקסט עד כה:\nטלפון';
                        setTimeout(() => {
                            transcriptDiv.textContent += '\nלמי תרצה להתקשר?';
                            listenForName();
                        }, 500);
                        break;
                    }
                }
                lastTranscript = fullTranscript;
            };

            recognition.start();
        }

        function listenForName() {
            let collected = '';
            const nameRecognition = new webkitSpeechRecognition();
            nameRecognition.lang = 'he-IL';
            nameRecognition.continuous = false;
            nameRecognition.interimResults = false;

            nameRecognition.onresult = function(event) {
                collected = event.results[0][0].transcript.trim();
                let matchFound = false;

                for (let contact of contacts) {
                    if (similarity(collected, contact) >= 0.8) {
                        playBeep(true);
                        transcriptDiv.textContent = `מתקשר ל... ${contact}`;
                        matchFound = true;
                        break;
                    }
                }
                if (!matchFound) {
                    playBeep(false);
                    transcriptDiv.textContent = `לא זוהה, נסה שוב.`;
                    setTimeout(() => listenForName(), 8000);
                }
            };

            setTimeout(() => {
                nameRecognition.stop();
            }, 8000);

            nameRecognition.start();
        }

        startSpeechRecognition();
    </script>
</body>
</html>
