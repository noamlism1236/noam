<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>זיהוי קולי - טלפון</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 50px;
      direction: rtl;
    }
    #status {
      font-size: 24px;
      margin-top: 20px;
    }
    #refresh {
      margin-top: 20px;
      display: none;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>🎙️ מערכת זיהוי קולי</h1>
  <div id="status">האזנה למילת הפעלה...</div>
  <button id="refresh" onclick="location.reload()">🔁 לחץ כדי לרענן</button>

  <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="failSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
  <audio id="wakeSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

  <script>
    const contactNames = ["יוסי כהן", "דני לוי", "מירי ברק", "רון אוחנה", "אורית מזרחי"];
    const status = document.getElementById("status");
    const refreshBtn = document.getElementById("refresh");
    const successSound = document.getElementById("successSound");
    const failSound = document.getElementById("failSound");
    const wakeSound = document.getElementById("wakeSound");

    let recognizing = false;
    let recognition;

    function initRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'he-IL';
      recognition.interimResults = true;
      recognition.continuous = false;
    }

    function listenForWakeWord() {
      if (recognizing) return;
      initRecognition();
      recognizing = true;
      status.textContent = "האזנה למילת הפעלה...";
      recognition.start();

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        if (transcript.includes("טלפון")) {
          wakeSound.play();
          listenForContact();
        } else {
          recognizing = false;
          listenForWakeWord(); // Keep listening
        }
      };

      recognition.onerror = () => {
        recognizing = false;
        listenForWakeWord();
      };

      recognition.onend = () => {
        recognizing = false;
        if (!recognition._listeningForContact) listenForWakeWord();
      };
    }

    function listenForContact() {
      recognition._listeningForContact = true;
      initRecognition();
      recognition.lang = 'he-IL';
      recognition.interimResults = true;

      const contactTimeout = setTimeout(() => {
        status.textContent = "לא זוהה, לחץ לרענון";
        failSound.play();
        refreshBtn.style.display = "inline-block";
        recognition.stop();
      }, 8000);  // Wait for 8 seconds for contact name

      status.textContent = "🗣️ אמור את שם איש הקשר";
      recognition.start();

      let finalTranscript = "";

      recognition.onresult = (event) => {
        let currentTranscript = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          currentTranscript += event.results[i][0].transcript;
        }
        finalTranscript = currentTranscript.trim();
        status.textContent = "👂 " + finalTranscript;

        for (let name of contactNames) {
          if (finalTranscript.includes(name)) {
            clearTimeout(contactTimeout);
            successSound.play();
            status.textContent = "📞 מתקשר אל " + name;
            setTimeout(() => {
              window.location.href = `tel:${Math.floor(Math.random() * 900000000) + 100000000}`;
            }, 1500);
            recognition.stop();
            return;
          }
        }
      };

      recognition.onerror = () => {
        clearTimeout(contactTimeout);
        failSound.play();
        status.textContent = "❌ שגיאה בזיהוי";
        refreshBtn.style.display = "inline-block";
      };

      recognition.onend = () => {
        recognition._listeningForContact = false;
      };
    }

    window.onload = () => {
      listenForWakeWord();
    };
  </script>
</body>
</html>
