<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>Voice Call Hebrew</title>
  <style>
    body {
      background-color: #fff;
      margin: 0;
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 40px;
      direction: rtl;
    }
    #status {
      font-size: 24px;
      color: #333;
    }
    #transcript {
      font-size: 20px;
      color: #666;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="status">מאזין...</div>
  <div id="transcript"></div>

<script>
  const contacts = {
    "יוסי שטיינבוך": "tel:+972501234567",
    "דני כהן": "tel:+972541234567",
    "אמא": "tel:+97239123456",
    "יהודה פרויינליך": "tel:+972502222222"
  };

  const statusEl = document.getElementById("status");
  const transcriptEl = document.getElementById("transcript");
  const synth = window.speechSynthesis;
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'he-IL';
  recognition.continuous = true; // שומר על ההאזנה ברקע
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;

  let stage = "waiting_for_phone";  // תחילת שלב החיפוש אחר "טלפון"

  // פונקציה להשמעת טקסט
  function speak(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'he-IL';
    synth.speak(utterance);
    statusEl.textContent = text;
  }

  // מתחיל להאזין למילת "טלפון"
  function startListeningForPhone() {
    statusEl.textContent = "נא לומר את המילה 'טלפון'...";
    speak("נא לומר את המילה 'טלפון'");
    recognition.start();
  }

  // מתחיל להאזין לשם איש קשר
  function startListeningForName() {
    statusEl.textContent = "נא לומר את שם איש הקשר...";
    speak("נא לומר את שם איש הקשר");
    recognition.start();
  }

  recognition.onend = () => {
    if (stage === "waiting_for_phone") {
      startListeningForPhone();
    } else if (stage === "waiting_for_name") {
      startListeningForName();
    }
  };

  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript.trim();
    console.log("Recognized:", transcript);

    // הצגת כל מה שנאמר בלייב
    transcriptEl.textContent = "אתה אמרת: " + transcript;

    if (stage === "waiting_for_phone") {
      if (transcript.includes("טלפון")) {
        speak("למי להתקשר?");
        statusEl.textContent = "למי להתקשר?";
        stage = "waiting_for_name";
        startListeningForName();
      }
    } else if (stage === "waiting_for_name") {
      const match = findBestMatch(transcript);
      if (match) {
        speak("מתקשר אל " + match);
        statusEl.textContent = "מתקשר אל " + match;
        setTimeout(() => {
          window.location.href = contacts[match];
        }, 2000);
      } else {
        speak("לא זוהה, נסה שם אחר");
        statusEl.textContent = "לא זוהה, נסה שם אחר";
        startListeningForName();
      }
    }
  };

  // פונקציה לחיפוש שמות המתאימים לטקסט שנאמר
  function findBestMatch(transcript) {
    const normalizedText = transcript.replace(/[^\u0590-\u05FF ]/g, '').trim();
    const words = normalizedText.split(/\s+/);
    const matchedNames = [];

    // נסה להתאים שמות מתוך אנשי הקשר
    for (let name in contacts) {
      const score = similarity(transcript, name);
      if (score > 0.85) {
        matchedNames.push({ name, score });
      }
    }

    matchedNames.sort((a, b) => b.score - a.score);
    return matchedNames.length > 0 ? matchedNames[0].name : null;
  }

  // פונקציה לחישוב דמיון בין שני טקסטים
  function similarity(a, b) {
    const longer = a.length > b.length ? a : b;
    const shorter = a.length > b.length ? b : a;
    const longerLength = longer.length;
    if (longerLength === 0) return 1.0;
    return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
  }

  // חישוב מרחק עריכה בין שני מיתרים
  function editDistance(s1, s2) {
    s1 = s1.toLowerCase();
    s2 = s2.toLowerCase();

    const costs = [];
    for (let i = 0; i <= s1.length; i++) {
      let lastValue = i;
      for (let j = 0; j <= s2.length; j++) {
        if (i === 0)
          costs[j] = j;
        else {
          if (j > 0) {
            let newValue = costs[j - 1];
            if (s1.charAt(i - 1) !== s2.charAt(j - 1))
              newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
            costs[j - 1] = lastValue;
            lastValue = newValue;
          }
        }
      }
      if (i > 0)
        costs[s2.length] = lastValue;
    }
    return costs[s2.length];
  }

  // אתחול המערכת כאשר הדף נטען
  window.onload = () => {
    startListeningForPhone();
  };
</script>
</body>
</html>
